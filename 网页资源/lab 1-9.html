<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡½æ•°å¤§å¸ˆ - æ·±é‚ƒæ˜Ÿç©ºç‰ˆ</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJaxåŠ è½½å®Œæˆ');
                    });
                }
            }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        /* æ·±é‚ƒæ¸å˜èƒŒæ™¯ - å¤šå±‚æ¬¡å åŠ  */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 25% 30%, rgba(25, 0, 60, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 75% 70%, rgba(0, 20, 80, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(5, 0, 30, 0.9) 0%, transparent 100%),
                linear-gradient(180deg, #000000 0%, #050514 50%, #000208 100%);
            z-index: -3;
        }

        /* æ˜Ÿç©ºå±‚ - ä¼˜åŒ–æ€§èƒ½ */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
            pointer-events: none;
        }

        /* é™æ€æ˜Ÿæ˜Ÿ - å‡å°‘åŠ¨ç”»æå‡æ€§èƒ½ */
        .star {
            position: absolute;
            background: #ffffff;
            border-radius: 50%;
            will-change: opacity;
        }

        .star.small {
            width: 1px;
            height: 1px;
            opacity: 0.5;
        }

        .star.medium {
            width: 1.5px;
            height: 1.5px;
            opacity: 0.7;
            box-shadow: 0 0 2px rgba(255,255,255,0.2);
        }

        .star.large {
            width: 2px;
            height: 2px;
            opacity: 0.9;
            box-shadow: 0 0 3px rgba(255,255,255,0.3);
        }

        /* åªç»™å°‘é‡æ˜Ÿæ˜Ÿæ·»åŠ æŸ”å’Œè„‰åŠ¨ */
        .star.pulse {
            animation: gentlePulse 6s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.9; }
        }

        /* æ˜Ÿäº‘æ•ˆæœå±‚ */
        .nebula {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.15;
            background: 
                radial-gradient(circle at 20% 80%, rgba(80, 60, 150, 0.3) 0%, transparent 45%),
                radial-gradient(circle at 80% 20%, rgba(130, 60, 150, 0.2) 0%, transparent 45%),
                radial-gradient(circle at 50% 50%, rgba(50, 100, 200, 0.2) 0%, transparent 50%);
            filter: blur(60px);
            transform: scale(1.2);
            animation: nebulaFloat 40s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes nebulaFloat {
            0%, 100% { transform: scale(1.2) rotate(0deg); }
            50% { transform: scale(1.3) rotate(3deg); }
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  - æ›´ç²¾è‡´çš„è®¾è®¡ */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .level-info {
            font-size: 24px;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
            letter-spacing: 2px;
        }

        .level-number {
            color: #6b9fff;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 0 20px rgba(107,159,255,0.5);
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .score-display {
            color: #9bb5ff;
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* æ¸¸æˆç½‘æ ¼ */
        .game-container {
            position: absolute;
            top: 90px;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-grid {
            display: grid;
            gap: 14px;
            padding: 25px;
            width: 100%;
            max-width: 1400px;
            height: 100%;
            max-height: 700px;
        }

        /* ç“·ç –æ ·å¼ - æ›´ç²¾è‡´çš„ç»ç’ƒæ€æ•ˆæœ */
        .tile {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255,255,255,0.9);
            padding: 8px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 10px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
            word-break: break-all;
            line-height: 1.3;
            letter-spacing: 0.5px;
        }

        .tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tile:hover::before {
            opacity: 1;
        }

        .tile:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 8px 20px rgba(107,159,255,0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
            border-color: rgba(107,159,255,0.3);
            background: rgba(255,255,255,0.06);
        }

        .tile.question {
            background: linear-gradient(135deg, rgba(107,159,255,0.08), rgba(107,159,255,0.04));
            border-color: rgba(107,159,255,0.15);
            color: #b3d0ff;
        }

        .tile.answer {
            background: linear-gradient(135deg, rgba(187,134,252,0.08), rgba(187,134,252,0.04));
            border-color: rgba(187,134,252,0.15);
            color: #d4b3ff;
        }

        /* é€‰ä¸­æ•ˆæœ - æ›´ä¼˜é›… */
        .tile.selected {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 
                0 0 0 2px rgba(100,255,180,0.5),
                0 10px 30px rgba(100,255,180,0.2),
                inset 0 0 20px rgba(100,255,180,0.05);
            border-color: rgba(100,255,180,0.5);
            background: linear-gradient(135deg, rgba(100,255,180,0.1), rgba(100,255,180,0.05));
            animation: selected-pulse 2s ease-in-out infinite;
        }

        @keyframes selected-pulse {
            0%, 100% { 
                box-shadow: 
                    0 0 0 2px rgba(100,255,180,0.5),
                    0 10px 30px rgba(100,255,180,0.2),
                    inset 0 0 20px rgba(100,255,180,0.05);
            }
            50% { 
                box-shadow: 
                    0 0 0 4px rgba(100,255,180,0.3),
                    0 10px 40px rgba(100,255,180,0.3),
                    inset 0 0 30px rgba(100,255,180,0.08);
            }
        }

        /* åŒ¹é…æˆåŠŸåŠ¨ç”» - æ›´ä¼˜é›… */
        @keyframes elegantDissolve {
            0% { 
                transform: scale(1);
                opacity: 1;
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.1);
                filter: brightness(1.5) blur(2px);
            }
            100% { 
                transform: scale(0.8);
                opacity: 0;
                filter: brightness(2) blur(10px);
            }
        }

        .tile.matched {
            animation: elegantDissolve 0.8s ease-out forwards;
        }

        /* ç²’å­æ•ˆæœ - æ›´ç²¾è‡´ */
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: radial-gradient(circle, rgba(255,255,255,0.9), transparent);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-fly 1.5s ease-out forwards;
        }

        @keyframes particle-fly {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }

        /* å…³å¡å®Œæˆç•Œé¢ - æ›´é«˜çº§çš„è®¾è®¡ */
        .level-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.98) 100%);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
        }

        .level-complete.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .complete-text {
            font-size: 64px;
            background: linear-gradient(135deg, #6b9fff, #bb86fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 300;
            margin-bottom: 30px;
            letter-spacing: 4px;
            animation: subtle-glow 3s ease-in-out infinite;
        }

        @keyframes subtle-glow {
            0%, 100% { 
                filter: brightness(1);
                transform: translateY(0);
            }
            50% { 
                filter: brightness(1.2);
                transform: translateY(-5px);
            }
        }

        .level-stats {
            background: rgba(255,255,255,0.02);
            backdrop-filter: blur(20px);
            padding: 30px 50px;
            border-radius: 16px;
            margin-bottom: 35px;
            color: rgba(255,255,255,0.8);
            font-size: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
            letter-spacing: 1px;
            font-weight: 300;
        }

        .next-btn {
            padding: 18px 45px;
            font-size: 18px;
            background: linear-gradient(135deg, rgba(107,159,255,0.2), rgba(187,134,252,0.2));
            backdrop-filter: blur(10px);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 300;
            letter-spacing: 2px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .next-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(107,159,255,0.3), rgba(187,134,252,0.3));
            box-shadow: 0 6px 30px rgba(107,159,255,0.3);
        }

        /* æ¸¸æˆå®Œæˆç•Œé¢ */
        .game-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.97) 0%, #000000 100%);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 3000;
        }

        .game-complete.show {
            display: flex;
        }

        .trophy {
            font-size: 120px;
            animation: gentle-rotate 8s linear infinite;
            filter: drop-shadow(0 0 30px rgba(255,215,0,0.5));
        }

        @keyframes gentle-rotate {
            from { 
                transform: rotate(0deg);
            }
            to { 
                transform: rotate(360deg);
            }
        }

        .final-text {
            font-size: 56px;
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 300;
            margin: 35px 0;
            letter-spacing: 3px;
        }

        .final-stats {
            background: rgba(255,255,255,0.02);
            backdrop-filter: blur(20px);
            padding: 35px 60px;
            border-radius: 16px;
            color: rgba(255,255,255,0.8);
            font-size: 22px;
            margin-bottom: 35px;
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .restart-game-btn {
            padding: 20px 50px;
            font-size: 20px;
            background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,200,87,0.2));
            backdrop-filter: blur(10px);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 300;
            letter-spacing: 2px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .restart-game-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(255,107,107,0.3), rgba(255,200,87,0.3));
            box-shadow: 0 6px 30px rgba(255,107,107,0.3);
        }

        /* æ‘‡æ™ƒåŠ¨ç”» */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .top-bar {
                padding: 0 15px;
                height: 60px;
            }

            .level-info {
                font-size: 20px;
            }

            .level-number {
                font-size: 24px;
            }

            .game-container {
                top: 80px;
            }

            .tile {
                font-size: 14px;
                padding: 6px;
            }

            .complete-text {
                font-size: 48px;
            }

            .final-text {
                font-size: 40px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>

    <style>
        .return-home-panel {
            position: fixed;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 10px;
            z-index: 9999;
            flex-wrap: wrap;
        }
        .return-home-panel .return-link {
            padding: 8px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            color: #f8fafc;
            font-size: 14px;
            text-decoration: none;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .return-home-panel .return-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.35);
        }
        .return-home-panel .return-link.return-main {
            background: rgba(79, 70, 229, 0.85);
        }
        @media (max-width: 640px) {
            .return-home-panel {
                top: 12px;
                left: 12px;
                right: 12px;
                justify-content: center;
            }
            .return-home-panel .return-link {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="return-home-panel">
        <a class="return-link return-sub" href="index.html">â† è¿”å›ç›®å½•</a>
        <a class="return-link return-main" href="../index.html">âŒ‚ è¿”å›ä¸»ç«™</a>
    </div>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="starfield" id="starfield"></div>
    <!-- æ˜Ÿäº‘å±‚ -->
    <div class="nebula"></div>

    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="top-bar">
        <div class="level-info">
            å…³å¡ <span class="level-number" id="currentLevel">1</span>
        </div>
        <div class="progress-info">
            <div class="score-display">
                è¿›åº¦: <span id="levelScore">0</span> / <span id="levelTotal">5</span>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div class="game-container">
        <div class="game-grid" id="gameGrid"></div>
    </div>

    <!-- å…³å¡å®Œæˆç•Œé¢ -->
    <div class="level-complete" id="levelComplete">
        <div class="complete-text">å…³å¡å®Œæˆ</div>
        <div class="level-stats">
            <p>å·²å®Œæˆç¬¬ <span id="completedLevel">1</span> å…³</p>
            <p>ç´¯è®¡å®Œæˆ: <span id="totalAnswered">0</span> / 1000</p>
        </div>
        <button class="next-btn" onclick="nextLevel()">ç»§ç»­æŒ‘æˆ˜</button>
    </div>

    <!-- å…¨éƒ¨å®Œæˆç•Œé¢ -->
    <div class="game-complete" id="gameComplete">
        <div class="trophy">ğŸ†</div>
        <div class="final-text">å‡½æ•°å¤§å¸ˆ</div>
        <div class="final-stats">
            <p>å®Œæˆå…¨éƒ¨ 1000 é“é¢˜ç›®</p>
            <p>é€šè¿‡ <span id="totalLevels">0</span> ä¸ªå…³å¡</p>
            <p>ä½ å·²æŒæ¡å‡½æ•°ç²¾é«“</p>
        </div>
        <button class="restart-game-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        // åˆ›å»ºä¼˜åŒ–çš„æ˜Ÿç©ºèƒŒæ™¯ - å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡ï¼Œæå‡æ€§èƒ½
        function createStarfield() {
            const starfield = document.getElementById('starfield');
            const starCount = 100; // å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡
            
            // åˆ›å»ºé™æ€æ˜Ÿæ˜Ÿ
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // éšæœºå¤§å°åˆ†å¸ƒ
                const rand = Math.random();
                if (rand < 0.6) {
                    star.classList.add('small');
                } else if (rand < 0.85) {
                    star.classList.add('medium');
                } else {
                    star.classList.add('large');
                }
                
                // åªç»™20%çš„æ˜Ÿæ˜Ÿæ·»åŠ è„‰åŠ¨æ•ˆæœ
                if (Math.random() < 0.2) {
                    star.classList.add('pulse');
                    star.style.animationDelay = Math.random() * 6 + 's';
                }
                
                // éšæœºä½ç½®
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                starfield.appendChild(star);
            }
            
            // æµæ˜Ÿæ›´å°‘æ›´ç¨€ç–
            setInterval(() => {
                if (Math.random() < 0.03) { // 3%æ¦‚ç‡ï¼Œæ›´ç¨€å°‘
                    createShootingStar();
                }
            }, 5000);
        }

        // åˆ›å»ºæµæ˜Ÿ
        function createShootingStar() {
            const starfield = document.getElementById('starfield');
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            shootingStar.style.left = Math.random() * 100 + '%';
            shootingStar.style.top = Math.random() * 30 + '%';
            shootingStar.style.width = (80 + Math.random() * 120) + 'px';
            starfield.appendChild(shootingStar);
            
            setTimeout(() => {
                shootingStar.remove();
            }, 4000);
        }

        // æ¸¸æˆçŠ¶æ€
        let currentLevel = 1;
        let levelScore = 0;
        let totalAnswered = 0;
        let usedProblems = new Set();
        let currentGrid = [];
        let selectedTile = null;
        let isProcessing = false;

        // ç”Ÿæˆè¶…å¤§é¢˜åº“ (1000é“é¢˜)
        function generateMegaDatabase() {
            const database = [];
            
            // å¤åˆå‡½æ•°å†…å±‚è¯†åˆ« (100é¢˜)
            const compositeOuter = ['\\sin', '\\cos', '\\tan', '\\ln', 'e^', '\\sqrt', '\\log_2', '\\log_3', '\\arcsin', '\\arccos'];
            const compositeInner = ['x^2', 'x^3', '2x', '3x-1', 'x+1', 'x^2-1', '\\sqrt{x}', '\\ln x', 'e^x', '\\sin x', '\\cos x', 'x^2+1', '2x+3', '3x^2', 'x-5', '4x+1'];
            
            for (let i = 0; i < 100; i++) {
                const o = compositeOuter[i % compositeOuter.length];
                const inn = compositeInner[i % compositeInner.length];
                
                if (o === 'e^') {
                    database.push({ q: `$e^{${inn}}$ å†…å±‚`, a: `$${inn}$` });
                } else if (o === '\\sqrt') {
                    database.push({ q: `$\\sqrt{${inn}}$ å†…å±‚`, a: `$${inn}$` });
                } else {
                    database.push({ q: `$${o}(${inn})$ å†…å±‚`, a: `$${inn}$` });
                }
            }
            
            // åŒºé—´è¡¨ç¤º (120é¢˜)
            for (let i = -15; i <= 15; i++) {
                for (let j = i + 1; j <= i + 4 && j <= 15; j++) {
                    if (database.length < 220) {
                        if (Math.random() > 0.5) {
                            database.push({ 
                                q: `$x \\in (${i}, ${j})$`, 
                                a: `$\\{x|${i}<x<${j}\\}$` 
                            });
                        } else {
                            database.push({ 
                                q: `$x \\in [${i}, ${j}]$`, 
                                a: `$\\{x|${i}\\leq x\\leq ${j}\\}$` 
                            });
                        }
                    }
                }
            }
            
            // å‡½æ•°æ€§è´¨ (100é¢˜)
            const functions = ['x', 'x^2', 'x^3', 'x^4', 'x^5', 'x^6', '|x|', '\\sin x', '\\cos x', '\\tan x', 
                             'e^x', 'e^{-x}', '\\ln x', '\\ln|x|', '\\frac{1}{x}', '\\sqrt{x}', '\\frac{1}{x^2}',
                             'x^2+1', 'x^3-x', '\\sin^2 x', '\\cos^2 x', 'x^4-x^2', '\\frac{x}{|x|}', '\\sqrt{x^2}'];
            
            functions.forEach((f, index) => {
                let parity = "éå¥‡éå¶";
                if (['x', 'x^3', 'x^5', '\\sin x', '\\tan x', '\\frac{1}{x}', 'x^3-x', '\\frac{x}{|x|}'].includes(f)) {
                    parity = "å¥‡å‡½æ•°";
                } else if (['x^2', 'x^4', 'x^6', '|x|', '\\cos x', '\\ln|x|', 'x^2+1', '\\sin^2 x', '\\cos^2 x', 'x^4-x^2', '\\frac{1}{x^2}', '\\sqrt{x^2}'].includes(f)) {
                    parity = "å¶å‡½æ•°";
                }
                
                database.push({ q: `$y=${f}$ å¥‡å¶æ€§`, a: parity });
                
                // æ·»åŠ å•è°ƒæ€§
                if (index < 12) {
                    let monotony = "æ— å•è°ƒæ€§";
                    if (['x', 'x^3', 'x^5', '\\sin x', '\\tan x', 'e^x', '\\ln x', '\\sqrt{x}'].includes(f)) {
                        monotony = "å•è°ƒé€’å¢";
                    } else if (['e^{-x}', '\\frac{1}{x}'].includes(f)) {
                        monotony = "å•è°ƒé€’å‡";
                    }
                    database.push({ q: `$y=${f}$ å•è°ƒæ€§`, a: monotony });
                }
            });
            
            // å®šä¹‰åŸŸ (150é¢˜)
            for (let a = 1; a <= 15; a++) {
                database.push(
                    { q: `$y=\\frac{1}{x-${a}}$ å®šä¹‰åŸŸ`, a: `$x\\neq ${a}$` },
                    { q: `$y=\\sqrt{x-${a}}$ å®šä¹‰åŸŸ`, a: `$x\\geq ${a}$` },
                    { q: `$y=\\sqrt{${a}-x}$ å®šä¹‰åŸŸ`, a: `$x\\leq ${a}$` },
                    { q: `$y=\\ln(x-${a})$ å®šä¹‰åŸŸ`, a: `$x>${a}$` },
                    { q: `$y=\\ln(${a}-x)$ å®šä¹‰åŸŸ`, a: `$x<${a}$` },
                    { q: `$y=\\frac{1}{x^2-${a}^2}$ å®šä¹‰åŸŸ`, a: `$x\\neq \\pm ${a}$` },
                    { q: `$y=\\sqrt{${a}^2-x^2}$ å®šä¹‰åŸŸ`, a: `$[-${a}, ${a}]$` },
                    { q: `$y=\\log_2(x+${a})$ å®šä¹‰åŸŸ`, a: `$x>-${a}$` },
                    { q: `$y=\\frac{\\sqrt{x-${a}}}{x}$ å®šä¹‰åŸŸ`, a: `$x\\geq ${a}, x\\neq 0$` },
                    { q: `$y=\\frac{1}{\\sqrt{x-${a}}}$ å®šä¹‰åŸŸ`, a: `$x>${a}$` }
                );
            }
            
            // åŸºæœ¬åˆç­‰å‡½æ•°å€¼ (120é¢˜)
            for (let i = 0; i < 6; i++) {
                database.push(
                    { q: "$e^0=$", a: "1" },
                    { q: "$\\ln 1=$", a: "0" },
                    { q: "$\\ln e=$", a: "1" },
                    { q: "$\\log_2 1=$", a: "0" },
                    { q: "$\\log_2 2=$", a: "1" },
                    { q: "$\\log_2 4=$", a: "2" },
                    { q: "$\\log_2 8=$", a: "3" },
                    { q: "$\\log_3 1=$", a: "0" },
                    { q: "$\\log_3 3=$", a: "1" },
                    { q: "$\\log_3 9=$", a: "2" },
                    { q: "$\\lg 1=$", a: "0" },
                    { q: "$\\lg 10=$", a: "1" },
                    { q: "$\\lg 100=$", a: "2" },
                    { q: "$\\lg 1000=$", a: "3" },
                    { q: "$2^0=$", a: "1" },
                    { q: "$2^5=$", a: "32" },
                    { q: "$3^3=$", a: "27" },
                    { q: "$4^2=$", a: "16" },
                    { q: "$5^2=$", a: "25" },
                    { q: "$6^2=$", a: "36" }
                );
            }
            
            // å‡½æ•°å€¼åŸŸ (100é¢˜)
            const rangeProblems = [
                { q: "$y=x^2$ å€¼åŸŸ", a: "$[0, +\\infty)$" },
                { q: "$y=x^3$ å€¼åŸŸ", a: "$\\mathbb{R}$" },
                { q: "$y=x^4$ å€¼åŸŸ", a: "$[0, +\\infty)$" },
                { q: "$y=\\sin x$ å€¼åŸŸ", a: "$[-1, 1]$" },
                { q: "$y=\\cos x$ å€¼åŸŸ", a: "$[-1, 1]$" },
                { q: "$y=\\tan x$ å€¼åŸŸ", a: "$\\mathbb{R}$" },
                { q: "$y=e^x$ å€¼åŸŸ", a: "$(0, +\\infty)$" },
                { q: "$y=\\ln x$ å€¼åŸŸ", a: "$\\mathbb{R}$" },
                { q: "$y=\\frac{1}{x}$ å€¼åŸŸ", a: "$\\mathbb{R}\\setminus\\{0\\}$" },
                { q: "$y=|x|$ å€¼åŸŸ", a: "$[0, +\\infty)$" },
                { q: "$y=\\sqrt{x}$ å€¼åŸŸ", a: "$[0, +\\infty)$" },
                { q: "$y=\\frac{1}{x^2}$ å€¼åŸŸ", a: "$(0, +\\infty)$" },
                { q: "$y=2^x$ å€¼åŸŸ", a: "$(0, +\\infty)$" },
                { q: "$y=\\arcsin x$ å€¼åŸŸ", a: "$[-\\frac{\\pi}{2}, \\frac{\\pi}{2}]$" },
                { q: "$y=\\arccos x$ å€¼åŸŸ", a: "$[0, \\pi]$" },
                { q: "$y=\\arctan x$ å€¼åŸŸ", a: "$(-\\frac{\\pi}{2}, \\frac{\\pi}{2})$" },
                { q: "$y=|\\sin x|$ å€¼åŸŸ", a: "$[0, 1]$" },
                { q: "$y=\\sin^2 x$ å€¼åŸŸ", a: "$[0, 1]$" },
                { q: "$y=\\cos^2 x$ å€¼åŸŸ", a: "$[0, 1]$" },
                { q: "$y=x^2+1$ å€¼åŸŸ", a: "$[1, +\\infty)$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...rangeProblems);
            }
            
            // ä¸‰è§’å‡½æ•°ç‰¹æ®Šå€¼ (120é¢˜)
            const angles = [0, 30, 45, 60, 90, 120, 135, 150, 180, 210, 225, 240, 270, 300, 315, 330, 360];
            const trigValues = {
                0: { sin: "0", cos: "1", tan: "0" },
                30: { sin: "$\\frac{1}{2}$", cos: "$\\frac{\\sqrt{3}}{2}$", tan: "$\\frac{\\sqrt{3}}{3}$" },
                45: { sin: "$\\frac{\\sqrt{2}}{2}$", cos: "$\\frac{\\sqrt{2}}{2}$", tan: "1" },
                60: { sin: "$\\frac{\\sqrt{3}}{2}$", cos: "$\\frac{1}{2}$", tan: "$\\sqrt{3}$" },
                90: { sin: "1", cos: "0", tan: "æ— å®šä¹‰" },
                120: { sin: "$\\frac{\\sqrt{3}}{2}$", cos: "$-\\frac{1}{2}$", tan: "$-\\sqrt{3}$" },
                135: { sin: "$\\frac{\\sqrt{2}}{2}$", cos: "$-\\frac{\\sqrt{2}}{2}$", tan: "$-1$" },
                150: { sin: "$\\frac{1}{2}$", cos: "$-\\frac{\\sqrt{3}}{2}$", tan: "$-\\frac{\\sqrt{3}}{3}$" },
                180: { sin: "0", cos: "$-1$", tan: "0" },
                210: { sin: "$-\\frac{1}{2}$", cos: "$-\\frac{\\sqrt{3}}{2}$", tan: "$\\frac{\\sqrt{3}}{3}$" },
                225: { sin: "$-\\frac{\\sqrt{2}}{2}$", cos: "$-\\frac{\\sqrt{2}}{2}$", tan: "1" },
                240: { sin: "$-\\frac{\\sqrt{3}}{2}$", cos: "$-\\frac{1}{2}$", tan: "$\\sqrt{3}$" },
                270: { sin: "$-1$", cos: "0", tan: "æ— å®šä¹‰" },
                300: { sin: "$-\\frac{\\sqrt{3}}{2}$", cos: "$\\frac{1}{2}$", tan: "$-\\sqrt{3}$" },
                315: { sin: "$-\\frac{\\sqrt{2}}{2}$", cos: "$\\frac{\\sqrt{2}}{2}$", tan: "$-1$" },
                330: { sin: "$-\\frac{1}{2}$", cos: "$\\frac{\\sqrt{3}}{2}$", tan: "$-\\frac{\\sqrt{3}}{3}$" },
                360: { sin: "0", cos: "1", tan: "0" }
            };
            
            angles.forEach(angle => {
                if (trigValues[angle]) {
                    database.push(
                        { q: `$\\sin ${angle}Â°=$`, a: trigValues[angle].sin },
                        { q: `$\\cos ${angle}Â°=$`, a: trigValues[angle].cos }
                    );
                    if (trigValues[angle].tan !== "æ— å®šä¹‰") {
                        database.push({ q: `$\\tan ${angle}Â°=$`, a: trigValues[angle].tan });
                    }
                }
            });
            
            // å‡½æ•°å˜æ¢ (120é¢˜)
            for (let i = 1; i <= 10; i++) {
                database.push(
                    { q: `$y=f(x)$ å‘ä¸Šå¹³ç§»${i}å•ä½`, a: `$y=f(x)+${i}$` },
                    { q: `$y=f(x)$ å‘ä¸‹å¹³ç§»${i}å•ä½`, a: `$y=f(x)-${i}$` },
                    { q: `$y=f(x)$ å‘å·¦å¹³ç§»${i}å•ä½`, a: `$y=f(x+${i})$` },
                    { q: `$y=f(x)$ å‘å³å¹³ç§»${i}å•ä½`, a: `$y=f(x-${i})$` },
                    { q: `$y=f(x)$ çºµå‘æ‹‰ä¼¸${i}å€`, a: `$y=${i}f(x)$` },
                    { q: `$y=\\sin x$ æŒ¯å¹…å˜ä¸º${i}`, a: `$y=${i}\\sin x$` },
                    { q: `$y=\\cos x$ å‘¨æœŸå˜ä¸º$\\frac{2\\pi}{${i}}$`, a: `$y=\\cos(${i}x)$` },
                    { q: `$y=x^2$ å‘å·¦å¹³ç§»${i}`, a: `$y=(x+${i})^2$` },
                    { q: `$y=|x|$ å‘ä¸Šå¹³ç§»${i}`, a: `$y=|x|+${i}$` },
                    { q: `$y=e^x$ å‘å³å¹³ç§»${i}`, a: `$y=e^{x-${i}}$` },
                    { q: `$y=\\ln x$ å‘ä¸Šå¹³ç§»${i}`, a: `$y=\\ln x+${i}$` },
                    { q: `$y=\\frac{1}{x}$ å‘å³å¹³ç§»${i}`, a: `$y=\\frac{1}{x-${i}}$` }
                );
            }
            
            // åå‡½æ•° (70é¢˜)
            const inverseFunctions = [
                { q: "$y=x$ çš„åå‡½æ•°", a: "$y=x$" },
                { q: "$y=x+1$ çš„åå‡½æ•°", a: "$y=x-1$" },
                { q: "$y=2x$ çš„åå‡½æ•°", a: "$y=\\frac{x}{2}$" },
                { q: "$y=3x$ çš„åå‡½æ•°", a: "$y=\\frac{x}{3}$" },
                { q: "$y=e^x$ çš„åå‡½æ•°", a: "$y=\\ln x$" },
                { q: "$y=\\ln x$ çš„åå‡½æ•°", a: "$y=e^x$" },
                { q: "$y=2^x$ çš„åå‡½æ•°", a: "$y=\\log_2 x$" },
                { q: "$y=\\log_2 x$ çš„åå‡½æ•°", a: "$y=2^x$" },
                { q: "$y=\\sin x$ çš„åå‡½æ•°", a: "$y=\\arcsin x$" },
                { q: "$y=\\cos x$ çš„åå‡½æ•°", a: "$y=\\arccos x$" },
                { q: "$y=\\tan x$ çš„åå‡½æ•°", a: "$y=\\arctan x$" },
                { q: "$y=\\sqrt{x}$ çš„åå‡½æ•°", a: "$y=x^2$" },
                { q: "$y=x^3$ çš„åå‡½æ•°", a: "$y=\\sqrt[3]{x}$" },
                { q: "$y=\\frac{1}{x}$ çš„åå‡½æ•°", a: "$y=\\frac{1}{x}$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...inverseFunctions);
            }
            
            console.log('é¢˜åº“ç”Ÿæˆå®Œæˆï¼Œæ€»é¢˜æ•°:', database.length);
            return database;
        }

        // å…¨å±€é¢˜åº“
        const megaDatabase = generateMegaDatabase();

        // è·å–å½“å‰å…³å¡çš„é¢˜ç›®æ•°é‡
        function getLevelPairs() {
            return Math.min(4 + currentLevel, 15); // æœ€å¤š15å¯¹é¢˜ç›®
        }

        // æ›´æ–°ç½‘æ ¼å¸ƒå±€
        function updateGridLayout() {
            const pairs = getLevelPairs();
            const total = pairs * 2;
            const grid = document.getElementById('gameGrid');
            
            let cols, rows;
            if (total <= 10) {
                cols = 5; rows = 2;
            } else if (total <= 15) {
                cols = 5; rows = 3;
            } else if (total <= 20) {
                cols = 5; rows = 4;
            } else if (total <= 24) {
                cols = 6; rows = 4;
            } else {
                cols = 6; rows = 5;
            }
            
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
        }

        // åˆ›å»ºä¼˜é›…çš„ç²’å­æ•ˆæœ
        function createParticles(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 12; i++) { // å‡å°‘ç²’å­æ•°é‡
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                
                const angle = (Math.PI * 2 * i) / 12;
                const distance = 150 + Math.random() * 100;
                particle.style.setProperty('--x', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--y', Math.sin(angle) * distance + 'px');
                
                const colors = ['#6b9fff', '#bb86fc', '#64ffda'];
                particle.style.background = `radial-gradient(circle, ${colors[Math.floor(Math.random() * colors.length)]}, transparent)`;
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1500);
            }
        }

        // åˆå§‹åŒ–å…³å¡
        function initLevel() {
            levelScore = 0;
            selectedTile = null;
            isProcessing = false;
            
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('levelScore').textContent = '0';
            document.getElementById('levelTotal').textContent = getLevelPairs();
            
            updateGridLayout();
            initGrid();
            renderGrid();
        }

        // åˆå§‹åŒ–ç½‘æ ¼æ•°æ®
        function initGrid() {
            currentGrid = [];
            const pairs = getLevelPairs();
            const availableProblems = megaDatabase.filter((problem, index) => !usedProblems.has(index));
            
            if (availableProblems.length < pairs) {
                showGameComplete();
                return;
            }
            
            const selectedProblems = [];
            const selectedIndices = [];
            
            while (selectedIndices.length < pairs && availableProblems.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableProblems.length);
                const problemIndex = megaDatabase.indexOf(availableProblems[randomIndex]);
                
                if (!usedProblems.has(problemIndex)) {
                    selectedIndices.push(problemIndex);
                    selectedProblems.push(megaDatabase[problemIndex]);
                    availableProblems.splice(randomIndex, 1);
                }
            }
            
            const tiles = [];
            selectedProblems.forEach((problem, index) => {
                tiles.push({
                    type: 'question',
                    content: problem.q,
                    matchAnswer: problem.a,
                    originalIndex: selectedIndices[index],
                    pairId: index
                });
                tiles.push({
                    type: 'answer',
                    content: problem.a,
                    matchAnswer: problem.a,
                    originalIndex: selectedIndices[index],
                    pairId: index
                });
            });
            
            tiles.sort(() => Math.random() - 0.5);
            currentGrid = tiles;
        }

        // æ¸²æŸ“ç½‘æ ¼
        function renderGrid() {
            const gridElement = document.getElementById('gameGrid');
            gridElement.innerHTML = '';
            
            currentGrid.forEach((tile, index) => {
                if (tile) {
                    const tileElement = document.createElement('div');
                    tileElement.className = `tile ${tile.type}`;
                    tileElement.innerHTML = tile.content;
                    tileElement.dataset.index = index;
                    tileElement.onclick = () => handleTileClick(index);
                    gridElement.appendChild(tileElement);
                }
            });
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        // å¤„ç†ç“·ç –ç‚¹å‡»
        function handleTileClick(index) {
            if (isProcessing) return;
            
            const tile = currentGrid[index];
            if (!tile) return;
            
            const tileElement = document.querySelector(`[data-index="${index}"]`);
            
            if (!selectedTile) {
                selectedTile = { index, tile, element: tileElement };
                tileElement.classList.add('selected');
            } else {
                if (selectedTile.index === index) {
                    tileElement.classList.remove('selected');
                    selectedTile = null;
                } else {
                    checkMatch(selectedTile, { index, tile, element: tileElement });
                }
            }
        }

        // æ£€æŸ¥åŒ¹é…
        function checkMatch(first, second) {
            isProcessing = true;
            
            const isMatch = (first.tile.type !== second.tile.type) && 
                           (first.tile.matchAnswer === second.tile.matchAnswer) &&
                           (first.tile.pairId === second.tile.pairId);
            
            if (isMatch) {
                second.element.classList.add('selected');
                
                setTimeout(() => {
                    createParticles(first.element);
                    createParticles(second.element);
                    
                    first.element.classList.add('matched');
                    second.element.classList.add('matched');
                    
                    usedProblems.add(first.tile.originalIndex);
                    
                    levelScore++;
                    totalAnswered++;
                    
                    document.getElementById('levelScore').textContent = levelScore;
                    
                    setTimeout(() => {
                        currentGrid[first.index] = null;
                        currentGrid[second.index] = null;
                        
                        first.element.style.visibility = 'hidden';
                        second.element.style.visibility = 'hidden';
                        
                        if (levelScore >= getLevelPairs()) {
                            setTimeout(showLevelComplete, 500);
                        }
                        
                        isProcessing = false;
                    }, 800);
                }, 200);
            } else {
                first.element.style.animation = 'shake 0.5s';
                second.element.style.animation = 'shake 0.5s';
                
                setTimeout(() => {
                    first.element.classList.remove('selected');
                    first.element.style.animation = '';
                    second.element.style.animation = '';
                    isProcessing = false;
                }, 500);
            }
            
            selectedTile = null;
        }

        // æ˜¾ç¤ºå…³å¡å®Œæˆ
        function showLevelComplete() {
            document.getElementById('completedLevel').textContent = currentLevel;
            document.getElementById('totalAnswered').textContent = totalAnswered;
            document.getElementById('levelComplete').classList.add('show');
        }

        // ä¸‹ä¸€å…³
        function nextLevel() {
            document.getElementById('levelComplete').classList.remove('show');
            currentLevel++;
            
            const remainingProblems = megaDatabase.length - usedProblems.size;
            if (remainingProblems < getLevelPairs()) {
                showGameComplete();
            } else {
                initLevel();
            }
        }

        // æ˜¾ç¤ºæ¸¸æˆå®Œæˆ
        function showGameComplete() {
            document.getElementById('totalLevels').textContent = currentLevel - 1;
            document.getElementById('gameComplete').classList.add('show');
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            currentLevel = 1;
            totalAnswered = 0;
            usedProblems.clear();
            document.getElementById('gameComplete').classList.remove('show');
            initLevel();
        }

        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', function() {
            createStarfield();
            console.log('æ·±é‚ƒæ˜Ÿç©ºå‡½æ•°å¤§å¸ˆå¯åŠ¨ï¼Œé¢˜åº“å¤§å°:', megaDatabase.length);
            initLevel();
        });
    </script>
</body>
</html>