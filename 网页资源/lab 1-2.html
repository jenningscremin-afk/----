<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹æ•°è¿ç®—å®éªŒå®¤</title>
    
    <!-- ========================================
         ä¿®å¤1ï¼šä½¿ç”¨æœ¬åœ°MathJaxï¼Œä¼˜åŒ–é…ç½®å‡å°‘å¡é¡¿
         ä¿®å¤2ï¼šå»¶è¿ŸåŠ è½½ï¼Œé¿å…é˜»å¡é¡µé¢
         ======================================== -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJaxåŠ è½½å®Œæˆ');
                    });
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <!-- ä½¿ç”¨deferå¼‚æ­¥åŠ è½½ï¼Œé¿å…é˜»å¡ -->
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>    
    <style>
        /* ========================================
           ç”¨æˆ·è¦æ±‚1ï¼šå­—å·ç»Ÿä¸€
           ======================================== */
        :root {
            --h1-size: 22px;      
            --h2-size: 20px;      
            --h3-size: 18px;      
            --btn-size: 16px;     
            --formula-size: 20px; 
            --text-size: 16px;
            
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #3730a3;
            --light: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ========================================
           ç”¨æˆ·è¦æ±‚ï¼šæ»šåŠ¨æ¡ç”Ÿæ•ˆä½†ä¸æ˜¾ç¤º
           ======================================== */
        *::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
        
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            font-size: var(--text-size);
            line-height: 1.5;
            background: var(--gray-50);
            color: var(--gray-800);
        }

        /* ========================================
           ç”¨æˆ·è¦æ±‚ï¼šæ¨ªå‘å¸ƒå±€ï¼ˆå®½æ˜¯é«˜çš„2å€ï¼‰ï¼Œå‹ç¼©é«˜åº¦
           ======================================== */
        .container {
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            max-height: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: var(--light);
        }

        .header {
            background: var(--primary);
            color: var(--light);
            padding: 8px 20px;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: var(--h2-size);
            margin: 0;
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========================================
           ç”¨æˆ·è¦æ±‚ï¼šä¾§è¾¹æ ä¸åŠ¨
           ======================================== */
        .sidebar {
            width: 120px;
            background: var(--gray-50);
            border-right: 1px solid var(--border);
            padding: 10px 8px;
        }

        .nav-btn {
            width: 100%;
            padding: 8px;
            margin-bottom: 4px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: var(--text-size);
            color: var(--gray-600);
            text-align: left;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: var(--gray-100);
        }

        .nav-btn.active {
            background: var(--primary);
            color: var(--light);
        }

        /* ========================================
           ç”¨æˆ·è¦æ±‚ï¼šæœ€å¤šå·¦å³ä¸¤æ ï¼Œå¿…é¡»æœ‰å¯è§†åŒ–
           ======================================== */
        .content {
            flex: 1;
            display: none;
            padding: 16px;
            overflow-y: auto;
        }

        .content.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .card {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .card h3 {
            font-size: var(--h3-size);
            color: var(--primary);
            margin-bottom: 12px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-size: var(--text-size);
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: var(--text-size);
            background: var(--gray-50);
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--light);
        }

        .btn {
            padding: 8px 16px;
            background: var(--primary);
            color: var(--light);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: var(--btn-size);
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .result {
            background: var(--gray-50);
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--primary);
            text-align: center;
            font-size: var(--text-size);
            margin: 12px 0;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .formula-box {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid var(--primary);
            margin: 12px 0;
            text-align: center;
            font-size: var(--formula-size);
        }

        .info-box {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: var(--text-size);
            text-align: center;
        }

        .steps {
            background: #fff9e6;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #f59e0b;
            line-height: 1.8;
            font-size: var(--text-size);
        }

        .canvas-container {
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            background: #fafafa;
            padding: 10px;
            min-height: 200px;
            max-height: 500px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
        }

        .tower-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 4px;
            min-height: 250px;
            max-height: 400px;
        }

        .tower-display {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .tower {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
        }

        .block {
            width: 40px;
            height: 25px;
            background: var(--primary);
            border: 1px solid var(--primary-dark);
            margin: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light);
            font-size: 12px;
            font-weight: bold;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .block.removing {
            opacity: 0.3;
            transform: translateX(50px);
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 4px;
            margin-top: 12px;
        }

        .slider-group label {
            min-width: 60px;
            font-size: var(--text-size);
        }

        .slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--gray-200);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }

        .rule-visual {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 4px;
            min-height: 150px;
        }

        .rule-tower {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rule-height {
            width: 30px;
            background: var(--primary);
            border-radius: 2px;
            margin-bottom: 5px;
        }

        .rule-label {
            font-size: 12px;
            color: var(--gray-600);
            text-align: center;
        }

        .operator {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            padding: 0 10px;
        }

        /* ========================================
           å“åº”å¼è®¾è®¡ï¼šå°å°ºå¯¸ä¸‹å¯¼èˆªæŒ‰é’®ç§»åˆ°ä¸Šæ–¹
           ======================================== */
        @media (max-width: 768px) {
            .main {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 8px 16px;
                display: flex;
                flex-direction: row;
                gap: 8px;
                overflow-x: auto;
                flex-shrink: 0;
                justify-content: center;
                flex-wrap: nowrap;
            }

            .nav-btn {
                min-width: 90px;
                text-align: center;
                margin-bottom: 0;
                white-space: nowrap;
                flex-shrink: 0;
                padding: 8px 12px;
                font-size: 14px;
            }

            .content.active {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .container {
                max-height: none;
                height: 100vh;
            }

            .header {
                padding: 6px 16px;
                height: 36px;
            }

            .header h1 {
                font-size: 18px;
            }

            .card {
                padding: 12px;
            }

            .canvas-container {
                min-height: 200px;
                max-height: 300px;
                padding: 8px;
            }

            .canvas-container canvas {
                width: 100%;
                max-width: 100%;
                height: auto;
            }

            .tower-container {
                min-height: 200px;
                max-height: 300px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 4px 12px;
                height: 32px;
            }

            .header h1 {
                font-size: 16px;
            }

            .sidebar {
                padding: 6px 8px;
                gap: 6px;
                justify-content: space-between;
            }

            .nav-btn {
                min-width: 75px;
                padding: 6px 8px;
                font-size: 13px;
                flex: 1;
                max-width: 100px;
            }

            .content {
                padding: 12px;
            }

            .card {
                padding: 10px;
            }

            .canvas-container {
                min-height: 180px;
                max-height: 250px;
                padding: 6px;
            }

            .canvas-container canvas {
                width: 100%;
                max-width: 100%;
                height: auto;
            }

            .tower-container {
                min-height: 180px;
                max-height: 250px;
            }
        }

        /* æå°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .sidebar {
                padding: 4px 6px;
                gap: 4px;
                /* ========================================
                   ä¿®å¤ï¼šæå°å±å¹•ç¡®ä¿æŒ‰é’®å¯ä»¥æ¨ªå‘æ»šåŠ¨æŸ¥çœ‹
                   ä¸å¼ºåˆ¶æŒ¤å‹ï¼Œä¿æŒæŒ‰é’®æœ€å°å¯è¯»å®½åº¦
                   ======================================== */
                overflow-x: auto;
                justify-content: flex-start;
            }

            .nav-btn {
                /* ========================================
                   ä¿®å¤ï¼šä¿æŒæœ€å°å®½åº¦ï¼Œç¡®ä¿æ–‡å­—ä¸è¢«æˆªæ–­
                   ç”¨æˆ·å¯é€šè¿‡æ¨ªå‘æ»šåŠ¨æŸ¥çœ‹æ‰€æœ‰æŒ‰é’®
                   ======================================== */
                min-width: 65px;
                padding: 5px 6px;
                font-size: 12px;
                flex-shrink: 0;
            }

            .header h1 {
                font-size: 14px;
            }
        }
    </style>

    <style>
        .return-home-panel {
            position: fixed;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 10px;
            z-index: 9999;
            flex-wrap: wrap;
        }
        .return-home-panel .return-link {
            padding: 8px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            color: #f8fafc;
            font-size: 14px;
            text-decoration: none;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .return-home-panel .return-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.35);
        }
        .return-home-panel .return-link.return-main {
            background: rgba(79, 70, 229, 0.85);
        }
        @media (max-width: 640px) {
            .return-home-panel {
                top: 12px;
                left: 12px;
                right: 12px;
                justify-content: center;
            }
            .return-home-panel .return-link {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="return-home-panel">
        <a class="return-link return-sub" href="index.html">â† è¿”å›ç›®å½•</a>
        <a class="return-link return-main" href="../index.html">âŒ‚ è¿”å›ä¸»ç«™</a>
    </div>
    <div class="container">
        <header class="header">
            <h1>å¯¹æ•°è¿ç®—å®éªŒå®¤</h1>
        </header>

        <div class="main">
            <!-- ä¾§è¾¹æ  -->
            <nav class="sidebar">
                <button class="nav-btn active" onclick="switchPanel('basic')">åŸºç¡€è®¡ç®—</button>
                <button class="nav-btn" onclick="switchPanel('tower')">æ‹†å¡”æ¸¸æˆ</button>
                <button class="nav-btn" onclick="switchPanel('rules')">è¿ç®—æ³•åˆ™</button>
            </nav>

            <!-- åŸºç¡€è®¡ç®—é¡µé¢ -->
            <div class="content active" id="basic">
                <div class="column">
                    <div class="card">
                        <h3>å¯¹æ•°è®¡ç®—</h3>
                        <div class="input-group">
                            <label>åº•æ•° a</label>
                            <input type="number" id="base" value="2" step="1" min="2">
                        </div>
                        <div class="input-group">
                            <label>çœŸæ•° x</label>
                            <input type="number" id="value" value="8" step="1" min="1">
                        </div>
                        <div class="result" id="result">
                            $\log_2 8 = 3$
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculate()">è®¡ç®—</button>
                            <button class="btn" onclick="randomCalc()">éšæœº</button>
                        </div>
                        <div class="formula-box" id="steps">
                            $\log_a x = n \Leftrightarrow a^n = x$
                        </div>
                    </div>

                    <div class="card">
                        <h3>ç‰¹æ®Šæƒ…å†µ</h3>
                        <div class="info-box">$\log_a 1 = 0$ (ä»»ä½•åº•æ•°)</div>
                        <div class="info-box">$\log_a a = 1$ (åº•æ•°ç­‰äºçœŸæ•°)</div>
                        <div class="info-box">$\log_a a^n = n$</div>
                        <div class="info-box">$a^{\log_a x} = x$</div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>å‡½æ•°å›¾åƒ</h3>
                        <div class="canvas-container">
                            <canvas id="graph" width="600" height="300"></canvas>
                        </div>
                        <div class="slider-group">
                            <label>åº•æ•° a</label>
                            <input type="range" class="slider" id="baseSlider" 
                                   min="2" max="10" step="1" value="2">
                            <span class="slider-value" id="sliderValue">2</span>
                        </div>
                        <div class="info-box" id="funcDesc">
                            $y = \log_2 x$ å•è°ƒé€’å¢
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‹†å¡”æ¸¸æˆé¡µé¢ -->
            <div class="content" id="tower">
                <div class="column">
                    <div class="card">
                        <h3>æ‹†å¡”æ¸¸æˆ - ç†è§£å¯¹æ•°</h3>
                        <div class="info-box">
                            å¯¹æ•°å°±æ˜¯åè¿‡æ¥é—®ï¼šéœ€è¦æ‹†å‡ æ¬¡ï¼Ÿ
                        </div>
                        <div class="input-group">
                            <label>ç§¯æœ¨å¡”å¤§å°ï¼ˆçœŸæ•°ï¼‰</label>
                            <select id="towerSize" onchange="updateTower()">
                                <option value="8" selected>8å—ç§¯æœ¨</option>
                                <option value="16">16å—ç§¯æœ¨</option>
                                <option value="32">32å—ç§¯æœ¨</option>
                                <option value="64">64å—ç§¯æœ¨</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>æ‹†è§£æ ‡å‡†ï¼ˆåº•æ•°ï¼‰</label>
                            <select id="towerBase" onchange="updateTower()">
                                <option value="2" selected>æ¯æ¬¡æ‹†ä¸€åŠï¼ˆåº•æ•°2ï¼‰</option>
                                <option value="4">æ¯æ¬¡æ‹†åˆ°1/4ï¼ˆåº•æ•°4ï¼‰</option>
                                <option value="8">æ¯æ¬¡æ‹†åˆ°1/8ï¼ˆåº•æ•°8ï¼‰</option>
                            </select>
                        </div>
                        <button class="btn" onclick="animateDismantling()" style="width: 100%; margin-top: 12px;">
                            å¼€å§‹æ‹†å¡”åŠ¨ç”»
                        </button>
                        <div class="steps" id="towerSteps">
                            å‡†å¤‡æ‹†è§£8å—ç§¯æœ¨çš„å¡”...<br>
                            ä½¿ç”¨åº•æ•°2ï¼ˆæ¯æ¬¡æ‹†ä¸€åŠï¼‰
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>æ‹†å¡”å¯è§†åŒ–</h3>
                        <div class="tower-container">
                            <div class="tower-display" id="towerVisual"></div>
                        </div>
                        <div class="result" id="towerResult">
                            $\log_2 8 = 3$ (éœ€è¦æ‹†3æ¬¡)
                        </div>
                        <div class="formula-box">
                            ğŸ—ï¸ ç§¯æœ¨å¡” = çœŸæ•°<br>
                            ğŸ”¨ æ‹†è§£æ ‡å‡† = åº•æ•°<br>
                            ğŸ“ æ‹†è§£æ¬¡æ•° = å¯¹æ•°
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿ç®—æ³•åˆ™é¡µé¢ -->
            <div class="content" id="rules">
                <div class="column">
                    <div class="card">
                        <h3>ä¹˜æ³•è§„åˆ™ï¼šå¡”é«˜ç›¸åŠ </h3>
                        <div class="formula-box">$\log_a(bc) = \log_a b + \log_a c$</div>
                        <div class="rule-visual" id="multiplyViz"></div>
                        <div class="steps">
                            ä¸¤ä¸ªå¡”çš„ç§¯æœ¨ç›¸ä¹˜ = å¡”é«˜ç›¸åŠ <br>
                            ä¾‹ï¼š8å— Ã— 16å— = 128å—<br>
                            $\log_2 8 + \log_2 16 = 3 + 4 = 7$<br>
                            $\log_2 128 = 7$ âœ“
                        </div>
                    </div>

                    <div class="card">
                        <h3>å¹‚æ¬¡è§„åˆ™ï¼šé‡å¤å åŠ </h3>
                        <div class="formula-box">$\log_a(b^c) = c \cdot \log_a b$</div>
                        <div class="steps">
                            æŠŠcä¸ªç›¸åŒçš„å¡”å åœ¨ä¸€èµ·<br>
                            ä¾‹ï¼š$8^3 = 512$<br>
                            $\log_2(8^3) = 3 \times \log_2 8 = 3 \times 3 = 9$
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>é™¤æ³•è§„åˆ™ï¼šå¡”é«˜ç›¸å‡</h3>
                        <div class="formula-box">$\log_a\left(\frac{b}{c}\right) = \log_a b - \log_a c$</div>
                        <div class="rule-visual" id="divideViz"></div>
                        <div class="steps">
                            å¤§å¡”é™¤ä»¥å°å¡” = å¡”é«˜ç›¸å‡<br>
                            ä¾‹ï¼š32å— Ã· 4å— = 8å—<br>
                            $\log_2 32 - \log_2 4 = 5 - 2 = 3$<br>
                            $\log_2 8 = 3$ âœ“
                        </div>
                    </div>

                    <div class="card">
                        <h3>æ¢åº•å…¬å¼ï¼šå•ä½æ¢ç®—</h3>
                        <div class="formula-box">$\log_a b = \frac{\log_c b}{\log_c a}$</div>
                        <div class="steps">
                            ç”¨æ ‡å‡†å°ºå­é‡ä¸åŒå°ºå­<br>
                            ä¾‹ï¼šæ±‚$\log_4 64$<br>
                            ç”¨2å·å°ºï¼š$\log_2 64 = 6$<br>
                            $\log_2 4 = 2$<br>
                            ç»“æœï¼š$\frac{6}{2} = 3$
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ä¿®å¤3ï¼šç®€åŒ–æ¸²æŸ“é€»è¾‘ï¼Œå‡å°‘é‡å¤è°ƒç”¨
        // ========================================
        function renderMath() {
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise().catch(err => console.log('æ¸²æŸ“é”™è¯¯:', err));
            }
        }

        // é¡µé¢åˆ‡æ¢
        function switchPanel(panel) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(panel).classList.add('active');
            
            // å»¶è¿Ÿæ¸²æŸ“å…¬å¼ï¼Œé¿å…å¡é¡¿
            setTimeout(() => {
                renderMath();
                if (panel === 'basic') drawGraph();
                if (panel === 'tower') updateTower();
                if (panel === 'rules') drawRuleVisuals();
            }, 50);
        }

        // è®¡ç®—å¯¹æ•°
        function calculate() {
            const base = parseFloat(document.getElementById('base').value);
            const value = parseFloat(document.getElementById('value').value);
            
            if (isNaN(base) || isNaN(value) || base <= 1 || value <= 0) {
                document.getElementById('result').innerHTML = 'è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—';
                return;
            }
            
            const result = Math.log(value) / Math.log(base);
            document.getElementById('result').innerHTML = `$\\log_{${base}} ${value} = ${result.toFixed(3)}$`;
            
            // æ›´æ–°æ­¥éª¤
            let steps = `é—®ï¼š${base}è¦è‡ªä¹˜å‡ æ¬¡å¾—åˆ°${value}ï¼Ÿ<br>`;
            let power = 1;
            for (let i = 1; i <= Math.min(5, Math.ceil(result)); i++) {
                power *= base;
                steps += `$${base}^${i} = ${power}$`;
                if (Math.abs(power - value) < 0.01) {
                    steps += ' âœ“';
                }
                steps += '<br>';
            }
            steps += `ç­”æ¡ˆï¼š${result.toFixed(2)}æ¬¡ï¼`;
            
            document.getElementById('steps').innerHTML = steps;
            
            // åŒæ­¥æ»‘å—
            document.getElementById('baseSlider').value = base;
            document.getElementById('sliderValue').textContent = base;
            
            drawGraph();
            renderMath();
        }

        // éšæœºè®¡ç®—
        function randomCalc() {
            const bases = [2, 3, 5, 10];
            const base = bases[Math.floor(Math.random() * bases.length)];
            const power = Math.floor(Math.random() * 4) + 1;
            const value = Math.pow(base, power);
            
            document.getElementById('base').value = base;
            document.getElementById('value').value = value;
            calculate();
        }

        // æ™ºèƒ½Canvasè‡ªé€‚åº”ç»˜åˆ¶å‡½æ•°å›¾åƒ
        function drawGraph() {
            const canvas = document.getElementById('graph');
            if (!canvas) return;
            
            // æ™ºèƒ½è®¡ç®—å®¹å™¨å°ºå¯¸
            const container = canvas.parentElement;
            const containerWidth = Math.max(200, container.clientWidth - 20);
            const containerHeight = Math.max(150, Math.min(400, container.clientHeight - 20));
            
            // è®¾ç½®Canvasæ˜¾ç¤ºå°ºå¯¸
            canvas.style.width = containerWidth + 'px';
            canvas.style.height = containerHeight + 'px';
            
            // è®¾ç½®Canvaså®é™…å°ºå¯¸ï¼ˆç”¨äºç»˜åˆ¶ï¼‰
            const devicePixelRatio = window.devicePixelRatio || 1;
            canvas.width = containerWidth * devicePixelRatio;
            canvas.height = containerHeight * devicePixelRatio;
            
            const ctx = canvas.getContext('2d');
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            const width = containerWidth;
            const height = containerHeight;
            const centerX = width * 0.2;
            const centerY = height / 2;
            
            ctx.clearRect(0, 0, width, height);
            
            const base = parseFloat(document.getElementById('baseSlider')?.value || 2);
            
            // æ™ºèƒ½è®¡ç®—ç½‘æ ¼å¯†åº¦å’Œç¼©æ”¾æ¯”ä¾‹
            const minGridSize = 20;
            const maxGridSize = 60;
            const gridDensity = Math.max(5, Math.min(15, Math.floor(width / 50)));
            const scale = Math.max(minGridSize, Math.min(maxGridSize, width / gridDensity));
            
            // æ™ºèƒ½ç½‘æ ¼ç»˜åˆ¶
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = width < 300 ? 0.3 : 0.5;
            
            // ä¸»ç½‘æ ¼çº¿
            for (let x = centerX % scale; x < width; x += scale) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            for (let y = centerY % scale; y < height; y += scale) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // åæ ‡è½´
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = width < 300 ? 1.5 : 2;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            // å¯¹æ•°æ›²çº¿
            ctx.strokeStyle = '#4f46e5';
            ctx.lineWidth = width < 300 ? 2 : 2.5;
            ctx.beginPath();
            
            let first = true;
            const stepSize = width < 300 ? 3 : 2;
            for (let px = centerX + 1; px <= width; px += stepSize) {
                const x = (px - centerX) / scale;
                if (x > 0) {
                    const y = Math.log(x) / Math.log(base);
                    const py = centerY - y * scale;
                    
                    if (py >= -10 && py <= height + 10) {
                        if (first) {
                            ctx.moveTo(px, py);
                            first = false;
                        } else {
                            ctx.lineTo(px, py);
                        }
                    }
                }
            }
            ctx.stroke();
            
            // æ ‡è®°ç‚¹(1,0)
            ctx.fillStyle = '#ef4444';
            const pointRadius = width < 300 ? 3 : 5;
            ctx.beginPath();
            ctx.arc(centerX + scale, centerY, pointRadius, 0, 2 * Math.PI);
            ctx.fill();
            
            // æ›´æ–°æè¿°
            const desc = document.getElementById('funcDesc');
            desc.innerHTML = `$y = \\log_{${base}} x$ å•è°ƒé€’å¢`;
            renderMath();
        }

        // æ›´æ–°æ‹†å¡”å¯è§†åŒ–
        function updateTower() {
            const size = parseInt(document.getElementById('towerSize').value);
            const base = parseInt(document.getElementById('towerBase').value);
            
            const visual = document.getElementById('towerVisual');
            visual.innerHTML = '';
            
            // è®¡ç®—éœ€è¦æ‹†å‡ æ¬¡
            const steps = Math.log(size) / Math.log(base);
            
            // åˆ›å»ºå¡”çš„å¯è§†åŒ–
            let currentSize = size;
            let stepCount = 0;
            
            while (currentSize > 1) {
                const tower = document.createElement('div');
                tower.className = 'tower';
                tower.id = `tower-${stepCount}`;
                
                // æ¯å±‚æœ€å¤šæ˜¾ç¤º4ä¸ªå—ï¼Œè¶…è¿‡å°±æ˜¾ç¤ºæ•°å­—
                const blocksToShow = Math.min(4, currentSize);
                for (let i = 0; i < blocksToShow; i++) {
                    const block = document.createElement('div');
                    block.className = 'block';
                    block.textContent = currentSize > 4 ? currentSize : '';
                    tower.appendChild(block);
                }
                
                visual.appendChild(tower);
                currentSize = Math.floor(currentSize / base);
                stepCount++;
            }
            
            // æœ€åå‰©ä½™1
            const finalTower = document.createElement('div');
            finalTower.className = 'tower';
            finalTower.innerHTML = '<div class="block">1</div>';
            visual.appendChild(finalTower);
            
            document.getElementById('towerResult').innerHTML = 
                `$\\log_{${base}} ${size} = ${steps.toFixed(2)}$ (éœ€è¦æ‹†${Math.ceil(steps)}æ¬¡)`;
            
            document.getElementById('towerSteps').innerHTML = 
                `å‡†å¤‡æ‹†è§£${size}å—ç§¯æœ¨çš„å¡”...<br>ä½¿ç”¨åº•æ•°${base}ï¼ˆæ¯æ¬¡æ‹†åˆ°1/${base}ï¼‰`;
            
            renderMath();
        }

        // æ‹†å¡”åŠ¨ç”»
        function animateDismantling() {
            const size = parseInt(document.getElementById('towerSize').value);
            const base = parseInt(document.getElementById('towerBase').value);
            
            let currentSize = size;
            let stepNum = 0;
            let stepText = '';
            
            const animate = () => {
                if (currentSize <= 1) {
                    document.getElementById('towerSteps').innerHTML = stepText + 
                        `<br><strong>å®Œæˆï¼æ€»å…±æ‹†äº†${stepNum}æ¬¡</strong>`;
                    renderMath();
                    return;
                }
                
                // æ·»åŠ ç§»é™¤åŠ¨ç”»
                const tower = document.getElementById(`tower-${stepNum}`);
                if (tower) {
                    tower.querySelectorAll('.block').forEach(block => {
                        block.classList.add('removing');
                    });
                }
                
                currentSize = Math.floor(currentSize / base);
                stepNum++;
                stepText += `ç¬¬${stepNum}æ¬¡ï¼šæ‹†åˆ°${currentSize}å—<br>`;
                
                document.getElementById('towerSteps').innerHTML = stepText;
                
                setTimeout(animate, 800);
            };
            
            // é‡ç½®åŠ¨ç”»
            updateTower();
            setTimeout(animate, 500);
        }

        // ç»˜åˆ¶è¿ç®—æ³•åˆ™å¯è§†åŒ–
        function drawRuleVisuals() {
            // ä¹˜æ³•è§„åˆ™å¯è§†åŒ–
            const multiplyViz = document.getElementById('multiplyViz');
            multiplyViz.innerHTML = `
                <div class="rule-tower">
                    <div class="rule-height" style="height: 60px;"></div>
                    <div class="rule-label">8å—<br>é«˜åº¦3</div>
                </div>
                <div class="operator">Ã—</div>
                <div class="rule-tower">
                    <div class="rule-height" style="height: 80px;"></div>
                    <div class="rule-label">16å—<br>é«˜åº¦4</div>
                </div>
                <div class="operator">=</div>
                <div class="rule-tower">
                    <div class="rule-height" style="height: 140px; background: #10b981;"></div>
                    <div class="rule-label">128å—<br>é«˜åº¦7</div>
                </div>
            `;
            
            // é™¤æ³•è§„åˆ™å¯è§†åŒ–
            const divideViz = document.getElementById('divideViz');
            divideViz.innerHTML = `
                <div class="rule-tower">
                    <div class="rule-height" style="height: 100px;"></div>
                    <div class="rule-label">32å—<br>é«˜åº¦5</div>
                </div>
                <div class="operator">Ã·</div>
                <div class="rule-tower">
                    <div class="rule-height" style="height: 40px;"></div>
                    <div class="rule-label">4å—<br>é«˜åº¦2</div>
                </div>
                <div class="operator">=</div>
                <div class="rule-tower">
                    <div class="rule-height" style="height: 60px; background: #10b981;"></div>
                    <div class="rule-label">8å—<br>é«˜åº¦3</div>
                </div>
            `;
        }

        // æ»‘å—äº‹ä»¶
        document.getElementById('baseSlider')?.addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('sliderValue').textContent = value;
            document.getElementById('base').value = value;
            drawGraph();
        });

        // é˜²æŠ–ä¼˜åŒ–ï¼šçª—å£å¤§å°å˜åŒ–æ—¶åªé‡ç»˜å½“å‰æ´»è·ƒé¢æ¿
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const activePanel = document.querySelector('.content.active');
                if (activePanel) {
                    const panelId = activePanel.id;
                    if (panelId === 'basic') {
                        drawGraph();
                    } else if (panelId === 'tower') {
                        updateTower();
                    } else if (panelId === 'rules') {
                        drawRuleVisuals();
                    }
                }
            }, 150); // å¢åŠ é˜²æŠ–å»¶è¿Ÿåˆ°150ms
        });

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…é˜»å¡
            setTimeout(() => {
                calculate();
                drawGraph();
                updateTower();
                drawRuleVisuals();
                renderMath();
            }, 100);
        });
    </script>
</body>
</html>