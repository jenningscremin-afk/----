<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‚å¯¼ç»ƒä¹ æ¸¸æˆ</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJaxåŠ è½½å®Œæˆ');
                    });
                }
            }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>
    <script defer src="../common-assets/js/lab-math-enhancer.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        /* æ·±é‚ƒæ¸å˜èƒŒæ™¯ - å¤šå±‚æ¬¡å åŠ  */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 25% 30%, rgba(25, 0, 60, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 75% 70%, rgba(0, 20, 80, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(5, 0, 30, 0.9) 0%, transparent 100%),
                linear-gradient(180deg, #000000 0%, #050514 50%, #000208 100%);
            z-index: -3;
        }

        /* æ˜Ÿç©ºå±‚ - ä¼˜åŒ–æ€§èƒ½ */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
            pointer-events: none;
        }

        /* é™æ€æ˜Ÿæ˜Ÿ - å‡å°‘åŠ¨ç”»æå‡æ€§èƒ½ */
        .star {
            position: absolute;
            background: #ffffff;
            border-radius: 50%;
            will-change: opacity;
        }

        .star.small {
            width: 1px;
            height: 1px;
            opacity: 0.5;
        }

        .star.medium {
            width: 1.5px;
            height: 1.5px;
            opacity: 0.7;
            box-shadow: 0 0 2px rgba(255,255,255,0.2);
        }

        .star.large {
            width: 2px;
            height: 2px;
            opacity: 0.9;
            box-shadow: 0 0 3px rgba(255,255,255,0.3);
        }

        /* åªç»™å°‘é‡æ˜Ÿæ˜Ÿæ·»åŠ æŸ”å’Œè„‰åŠ¨ */
        .star.pulse {
            animation: gentlePulse 6s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.9; }
        }

        /* æ˜Ÿäº‘æ•ˆæœå±‚ */
        .nebula {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.15;
            background: 
                radial-gradient(circle at 20% 80%, rgba(80, 60, 150, 0.3) 0%, transparent 45%),
                radial-gradient(circle at 80% 20%, rgba(130, 60, 150, 0.2) 0%, transparent 45%),
                radial-gradient(circle at 50% 50%, rgba(50, 100, 200, 0.2) 0%, transparent 50%);
            filter: blur(60px);
            transform: scale(1.2);
            animation: nebulaFloat 40s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes nebulaFloat {
            0%, 100% { transform: scale(1.2) rotate(0deg); }
            50% { transform: scale(1.3) rotate(3deg); }
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  - æ›´ç²¾è‡´çš„è®¾è®¡ */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .level-info {
            font-size: 24px;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
            letter-spacing: 2px;
        }

        .level-number {
            color: #6b9fff;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 0 20px rgba(107,159,255,0.5);
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .score-display {
            color: #9bb5ff;
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* æ¸¸æˆç½‘æ ¼ */
        .game-container {
            position: absolute;
            top: 90px;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-grid {
            display: grid;
            gap: 10px;
            padding: 20px;
            width: 100%;
            max-width: 1600px;
            height: 100%;
            max-height: 750px;
        }

        /* ç“·ç –æ ·å¼ - æ›´ç²¾è‡´çš„ç»ç’ƒæ€æ•ˆæœ */
        .tile {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255,255,255,0.9);
            padding: 10px 12px;
            text-align: center;
            position: relative;
            overflow: auto;
            box-shadow: 
                0 4px 10px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.5;
            letter-spacing: 0.3px;
            min-height: 80px;
        }

        .tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tile:hover::before {
            opacity: 1;
        }

        .tile:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 8px 20px rgba(107,159,255,0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
            border-color: rgba(107,159,255,0.3);
            background: rgba(255,255,255,0.06);
        }

        .tile.question {
            background: linear-gradient(135deg, rgba(107,159,255,0.08), rgba(107,159,255,0.04));
            border-color: rgba(107,159,255,0.15);
            color: #b3d0ff;
        }

        .tile.answer {
            background: linear-gradient(135deg, rgba(187,134,252,0.08), rgba(187,134,252,0.04));
            border-color: rgba(187,134,252,0.15);
            color: #d4b3ff;
        }

        /* é€‰ä¸­æ•ˆæœ - æ›´ä¼˜é›… */
        .tile.selected {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 
                0 0 0 2px rgba(100,255,180,0.5),
                0 10px 30px rgba(100,255,180,0.2),
                inset 0 0 20px rgba(100,255,180,0.05);
            border-color: rgba(100,255,180,0.5);
            background: linear-gradient(135deg, rgba(100,255,180,0.1), rgba(100,255,180,0.05));
            animation: selected-pulse 2s ease-in-out infinite;
        }

        @keyframes selected-pulse {
            0%, 100% { 
                box-shadow: 
                    0 0 0 2px rgba(100,255,180,0.5),
                    0 10px 30px rgba(100,255,180,0.2),
                    inset 0 0 20px rgba(100,255,180,0.05);
            }
            50% { 
                box-shadow: 
                    0 0 0 4px rgba(100,255,180,0.3),
                    0 10px 40px rgba(100,255,180,0.3),
                    inset 0 0 30px rgba(100,255,180,0.08);
            }
        }

        /* åŒ¹é…æˆåŠŸåŠ¨ç”» - æ›´ä¼˜é›… */
        @keyframes elegantDissolve {
            0% { 
                transform: scale(1);
                opacity: 1;
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.1);
                filter: brightness(1.5) blur(2px);
            }
            100% { 
                transform: scale(0.8);
                opacity: 0;
                filter: brightness(2) blur(10px);
            }
        }

        .tile.matched {
            animation: elegantDissolve 0.8s ease-out forwards;
        }

        /* ç²’å­æ•ˆæœ - æ›´ç²¾è‡´ */
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: radial-gradient(circle, rgba(255,255,255,0.9), transparent);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-fly 1.5s ease-out forwards;
        }

        @keyframes particle-fly {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }

        /* å…³å¡å®Œæˆç•Œé¢ - æ›´é«˜çº§çš„è®¾è®¡ */
        .level-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.98) 100%);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
        }

        .level-complete.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .complete-text {
            font-size: 64px;
            background: linear-gradient(135deg, #6b9fff, #bb86fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 300;
            margin-bottom: 30px;
            letter-spacing: 4px;
            animation: subtle-glow 3s ease-in-out infinite;
        }

        @keyframes subtle-glow {
            0%, 100% { 
                filter: brightness(1);
                transform: translateY(0);
            }
            50% { 
                filter: brightness(1.2);
                transform: translateY(-5px);
            }
        }

        .level-stats {
            background: rgba(255,255,255,0.02);
            backdrop-filter: blur(20px);
            padding: 30px 50px;
            border-radius: 16px;
            margin-bottom: 35px;
            color: rgba(255,255,255,0.8);
            font-size: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
            letter-spacing: 1px;
            font-weight: 300;
        }

        .next-btn {
            padding: 18px 45px;
            font-size: 18px;
            background: linear-gradient(135deg, rgba(107,159,255,0.2), rgba(187,134,252,0.2));
            backdrop-filter: blur(10px);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 300;
            letter-spacing: 2px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .next-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(107,159,255,0.3), rgba(187,134,252,0.3));
            box-shadow: 0 6px 30px rgba(107,159,255,0.3);
        }

        /* æ¸¸æˆå®Œæˆç•Œé¢ */
        .game-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.97) 0%, #000000 100%);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 3000;
        }

        .game-complete.show {
            display: flex;
        }

        .trophy {
            font-size: 120px;
            animation: gentle-rotate 8s linear infinite;
            filter: drop-shadow(0 0 30px rgba(255,215,0,0.5));
        }

        @keyframes gentle-rotate {
            from { 
                transform: rotate(0deg);
            }
            to { 
                transform: rotate(360deg);
            }
        }

        .final-text {
            font-size: 56px;
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 300;
            margin: 35px 0;
            letter-spacing: 3px;
        }

        .final-stats {
            background: rgba(255,255,255,0.02);
            backdrop-filter: blur(20px);
            padding: 35px 60px;
            border-radius: 16px;
            color: rgba(255,255,255,0.8);
            font-size: 22px;
            margin-bottom: 35px;
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .restart-game-btn {
            padding: 20px 50px;
            font-size: 20px;
            background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,200,87,0.2));
            backdrop-filter: blur(10px);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 300;
            letter-spacing: 2px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .restart-game-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(255,107,107,0.3), rgba(255,200,87,0.3));
            box-shadow: 0 6px 30px rgba(255,107,107,0.3);
        }

        /* æ‘‡æ™ƒåŠ¨ç”» */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .top-bar {
                padding: 0 15px;
                height: 60px;
            }

            .level-info {
                font-size: 20px;
            }

            .level-number {
                font-size: 24px;
            }

            .game-container {
                top: 80px;
            }

            .tile {
                font-size: 14px;
                padding: 6px;
            }

            .complete-text {
                font-size: 48px;
            }

            .final-text {
                font-size: 40px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>

    <style>
        .return-home-panel {
            position: fixed;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 10px;
            z-index: 9999;
            flex-wrap: wrap;
        }
        .return-home-panel .return-link {
            padding: 8px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            color: #f8fafc;
            font-size: 14px;
            text-decoration: none;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .return-home-panel .return-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.35);
        }
        .return-home-panel .return-link.return-main {
            background: rgba(79, 70, 229, 0.85);
        }
        @media (max-width: 640px) {
            .return-home-panel {
                top: 12px;
                left: 12px;
                right: 12px;
                justify-content: center;
            }
            .return-home-panel .return-link {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="return-home-panel">
        <a class="return-link return-sub" href="index.html">â† è¿”å›ç›®å½•</a>
        <a class="return-link return-main" href="../index.html">âŒ‚ è¿”å›ä¸»ç«™</a>
    </div>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="starfield" id="starfield"></div>
    <!-- æ˜Ÿäº‘å±‚ -->
    <div class="nebula"></div>

    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="top-bar">
        <div class="level-info">
            å…³å¡ <span class="level-number" id="currentLevel">1</span>
        </div>
        <div class="progress-info">
            <div class="score-display">
                è¿›åº¦: <span id="levelScore">0</span> / <span id="levelTotal">5</span>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div class="game-container">
        <div class="game-grid" id="gameGrid"></div>
    </div>

    <!-- å…³å¡å®Œæˆç•Œé¢ -->
    <div class="level-complete" id="levelComplete">
        <div class="complete-text">å…³å¡å®Œæˆ</div>
        <div class="level-stats">
            <p>å·²å®Œæˆç¬¬ <span id="completedLevel">1</span> å…³</p>
            <p>ç´¯è®¡å®Œæˆ: <span id="totalAnswered">0</span></p>
        </div>
        <button class="next-btn" onclick="nextLevel()">ç»§ç»­æŒ‘æˆ˜</button>
    </div>

    <!-- å…¨éƒ¨å®Œæˆç•Œé¢ -->
    <div class="game-complete" id="gameComplete">
        <div class="trophy">ğŸ†</div>
        <div class="final-text">æ±‚å¯¼å¤§å¸ˆ</div>
        <div class="final-stats">
            <p>å®Œæˆå…¨éƒ¨ 1000 é“é¢˜ç›®</p>
            <p>é€šè¿‡ <span id="totalLevels">0</span> ä¸ªå…³å¡</p>
            <p>ä½ å·²æŒæ¡æ±‚å¯¼ç²¾é«“</p>
        </div>
        <button class="restart-game-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        // åˆ›å»ºä¼˜åŒ–çš„æ˜Ÿç©ºèƒŒæ™¯ - å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡ï¼Œæå‡æ€§èƒ½
        function createStarfield() {
            const starfield = document.getElementById('starfield');
            const starCount = 100; // å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡
            
            // åˆ›å»ºé™æ€æ˜Ÿæ˜Ÿ
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // éšæœºå¤§å°åˆ†å¸ƒ
                const rand = Math.random();
                if (rand < 0.6) {
                    star.classList.add('small');
                } else if (rand < 0.85) {
                    star.classList.add('medium');
                } else {
                    star.classList.add('large');
                }
                
                // åªç»™20%çš„æ˜Ÿæ˜Ÿæ·»åŠ è„‰åŠ¨æ•ˆæœ
                if (Math.random() < 0.2) {
                    star.classList.add('pulse');
                    star.style.animationDelay = Math.random() * 6 + 's';
                }
                
                // éšæœºä½ç½®
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                starfield.appendChild(star);
            }
            
            // æµæ˜Ÿæ›´å°‘æ›´ç¨€ç–
            setInterval(() => {
                if (Math.random() < 0.03) { // 3%æ¦‚ç‡ï¼Œæ›´ç¨€å°‘
                    createShootingStar();
                }
            }, 5000);
        }

        // åˆ›å»ºæµæ˜Ÿ
        function createShootingStar() {
            const starfield = document.getElementById('starfield');
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            shootingStar.style.left = Math.random() * 100 + '%';
            shootingStar.style.top = Math.random() * 30 + '%';
            shootingStar.style.width = (80 + Math.random() * 120) + 'px';
            starfield.appendChild(shootingStar);
            
            setTimeout(() => {
                shootingStar.remove();
            }, 4000);
        }

        // æ¸¸æˆçŠ¶æ€
        let currentLevel = 1;
        let levelScore = 0;
        let totalAnswered = 0;
        let usedProblems = new Set();
        let currentGrid = [];
        let selectedTile = null;
        let isProcessing = false;

        // ç”Ÿæˆæ±‚å¯¼é¢˜åº“ (1000é“é¢˜)
        function generateMegaDatabase() {
            const database = [];
            
            // åŸºç¡€å¹‚å‡½æ•°æ±‚å¯¼ (200é¢˜)
            const basicPowerDerivatives = [
                { q: "$y = x^2$", a: "$2x$" },
                { q: "$y = x^3$", a: "$3x^2$" },
                { q: "$y = x^4$", a: "$4x^3$" },
                { q: "$y = x^5$", a: "$5x^4$" },
                { q: "$y = 2x$", a: "$2$" },
                { q: "$y = 3x^2$", a: "$6x$" },
                { q: "$y = 4x^3$", a: "$12x^2$" },
                { q: "$y = 5x^2$", a: "$10x$" },
                { q: "$y = \\frac{1}{x}$", a: "$-\\frac{1}{x^2}$" },
                { q: "$y = \\sqrt{x}$", a: "$\\frac{1}{2\\sqrt{x}}$" },
                { q: "$y = x$", a: "$1$" },
                { q: "$y = 5$", a: "$0$" },
                { q: "$y = 2x^3$", a: "$6x^2$" },
                { q: "$y = \\frac{x^2}{2}$", a: "$x$" },
                { q: "$y = \\frac{x^3}{3}$", a: "$x^2$" },
                { q: "$y = 2x^2 + 3$", a: "$4x$" },
                { q: "$y = x^2 + 2x$", a: "$2x + 2$" },
                { q: "$y = x^3 - x$", a: "$3x^2 - 1$" },
                { q: "$y = 3x^2 + 2x$", a: "$6x + 2$" },
                { q: "$y = x^2 - 3x + 2$", a: "$2x - 3$" },
                { q: "$y = 2x^3 - x^2$", a: "$6x^2 - 2x$" },
                { q: "$y = x^4 + x^2$", a: "$4x^3 + 2x$" },
                { q: "$y = \\frac{1}{x^2}$", a: "$-\\frac{2}{x^3}$" },
                { q: "$y = \\frac{1}{x^3}$", a: "$-\\frac{3}{x^4}$" },
                { q: "$y = x^{-1}$", a: "$-x^{-2}$" },
                { q: "$y = x^{-2}$", a: "$-2x^{-3}$" },
                { q: "$y = 2\\sqrt{x}$", a: "$\\frac{1}{\\sqrt{x}}$" },
                { q: "$y = 3\\sqrt{x}$", a: "$\\frac{3}{2\\sqrt{x}}$" },
                { q: "$y = x^{1/2}$", a: "$\\frac{1}{2}x^{-1/2}$" },
                { q: "$y = x^{3/2}$", a: "$\\frac{3}{2}x^{1/2}$" },
                { q: "$y = \\sqrt[3]{x}$", a: "$\\frac{1}{3}x^{-2/3}$" },
                { q: "$y = x^{1/3}$", a: "$\\frac{1}{3}x^{-2/3}$" },
                { q: "$y = 4x^2 + 1$", a: "$8x$" },
                { q: "$y = 3x^3 + x$", a: "$9x^2 + 1$" },
                { q: "$y = x^2 + 5$", a: "$2x$" },
                { q: "$y = 2x^2 - 4x$", a: "$4x - 4$" },
                { q: "$y = x^3 + 2x^2$", a: "$3x^2 + 4x$" },
                { q: "$y = 5x - 3$", a: "$5$" },
                { q: "$y = -x^2$", a: "$-2x$" },
                { q: "$y = -3x$", a: "$-3$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...basicPowerDerivatives);
            }
            
            // åŸºç¡€ä¸‰è§’å‡½æ•°æ±‚å¯¼ (150é¢˜)
            const basicTrigDerivatives = [
                { q: "$y = \\sin x$", a: "$\\cos x$" },
                { q: "$y = \\cos x$", a: "$-\\sin x$" },
                { q: "$y = \\tan x$", a: "$\\sec^2 x$" },
                { q: "$y = 2\\sin x$", a: "$2\\cos x$" },
                { q: "$y = 3\\cos x$", a: "$-3\\sin x$" },
                { q: "$y = \\sin x + \\cos x$", a: "$\\cos x - \\sin x$" },
                { q: "$y = \\sin x - \\cos x$", a: "$\\cos x + \\sin x$" },
                { q: "$y = 2\\sin x + 3\\cos x$", a: "$2\\cos x - 3\\sin x$" },
                { q: "$y = x + \\sin x$", a: "$1 + \\cos x$" },
                { q: "$y = x - \\cos x$", a: "$1 + \\sin x$" },
                { q: "$y = x^2 + \\sin x$", a: "$2x + \\cos x$" },
                { q: "$y = x^2 - \\cos x$", a: "$2x + \\sin x$" },
                { q: "$y = 2x + \\sin x$", a: "$2 + \\cos x$" },
                { q: "$y = 3x - \\cos x$", a: "$3 + \\sin x$" },
                { q: "$y = \\sin x + 1$", a: "$\\cos x$" },
                { q: "$y = \\cos x + 2$", a: "$-\\sin x$" },
                { q: "$y = 5\\sin x$", a: "$5\\cos x$" },
                { q: "$y = 4\\cos x$", a: "$-4\\sin x$" },
                { q: "$y = -\\sin x$", a: "$-\\cos x$" },
                { q: "$y = -\\cos x$", a: "$\\sin x$" },
                { q: "$y = 2\\tan x$", a: "$2\\sec^2 x$" },
                { q: "$y = x\\sin x$", a: "$\\sin x + x\\cos x$" },
                { q: "$y = x\\cos x$", a: "$\\cos x - x\\sin x$" },
                { q: "$y = \\frac{\\sin x}{2}$", a: "$\\frac{\\cos x}{2}$" },
                { q: "$y = \\frac{\\cos x}{3}$", a: "$-\\frac{\\sin x}{3}$" },
                { q: "$y = x^3 + \\sin x$", a: "$3x^2 + \\cos x$" },
                { q: "$y = x^2 + 2\\cos x$", a: "$2x - 2\\sin x$" },
                { q: "$y = \\sin x + \\cos x + x$", a: "$\\cos x - \\sin x + 1$" },
                { q: "$y = 2\\sin x - x$", a: "$2\\cos x - 1$" },
                { q: "$y = 3\\cos x + x^2$", a: "$-3\\sin x + 2x$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...basicTrigDerivatives);
            }
            
            // åŸºç¡€æŒ‡æ•°å¯¹æ•°å‡½æ•°æ±‚å¯¼ (150é¢˜)
            const basicExpLogDerivatives = [
                { q: "$y = e^x$", a: "$e^x$" },
                { q: "$y = 2e^x$", a: "$2e^x$" },
                { q: "$y = 3e^x$", a: "$3e^x$" },
                { q: "$y = \\ln x$", a: "$\\frac{1}{x}$" },
                { q: "$y = 2\\ln x$", a: "$\\frac{2}{x}$" },
                { q: "$y = 3\\ln x$", a: "$\\frac{3}{x}$" },
                { q: "$y = e^x + 1$", a: "$e^x$" },
                { q: "$y = e^x - x$", a: "$e^x - 1$" },
                { q: "$y = e^x + x$", a: "$e^x + 1$" },
                { q: "$y = \\ln x + x$", a: "$\\frac{1}{x} + 1$" },
                { q: "$y = \\ln x - x$", a: "$\\frac{1}{x} - 1$" },
                { q: "$y = x + e^x$", a: "$1 + e^x$" },
                { q: "$y = x^2 + e^x$", a: "$2x + e^x$" },
                { q: "$y = x^2 + \\ln x$", a: "$2x + \\frac{1}{x}$" },
                { q: "$y = 2^x$", a: "$2^x \\ln 2$" },
                { q: "$y = 3^x$", a: "$3^x \\ln 3$" },
                { q: "$y = \\log_2 x$", a: "$\\frac{1}{x\\ln 2}$" },
                { q: "$y = \\log_3 x$", a: "$\\frac{1}{x\\ln 3}$" },
                { q: "$y = 5e^x$", a: "$5e^x$" },
                { q: "$y = 4\\ln x$", a: "$\\frac{4}{x}$" },
                { q: "$y = e^x + 2x$", a: "$e^x + 2$" },
                { q: "$y = \\ln x + 3x$", a: "$\\frac{1}{x} + 3$" },
                { q: "$y = 2e^x - 1$", a: "$2e^x$" },
                { q: "$y = 3\\ln x + 2$", a: "$\\frac{3}{x}$" },
                { q: "$y = x^3 + e^x$", a: "$3x^2 + e^x$" },
                { q: "$y = x^2 - \\ln x$", a: "$2x - \\frac{1}{x}$" },
                { q: "$y = e^x + \\sin x$", a: "$e^x + \\cos x$" },
                { q: "$y = \\ln x + \\cos x$", a: "$\\frac{1}{x} - \\sin x$" },
                { q: "$y = -e^x$", a: "$-e^x$" },
                { q: "$y = -\\ln x$", a: "$-\\frac{1}{x}$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...basicExpLogDerivatives);
            }
            
            // ç®€å•å¤åˆå‡½æ•°æ±‚å¯¼ (200é¢˜)
            const simpleCompositeDerivatives = [
                { q: "$y = (x + 1)^2$", a: "$2(x + 1)$" },
                { q: "$y = (x - 1)^2$", a: "$2(x - 1)$" },
                { q: "$y = (2x)^2$", a: "$8x$" },
                { q: "$y = (3x)^2$", a: "$18x$" },
                { q: "$y = (x + 2)^3$", a: "$3(x + 2)^2$" },
                { q: "$y = (x - 2)^3$", a: "$3(x - 2)^2$" },
                { q: "$y = \\sin 2x$", a: "$2\\cos 2x$" },
                { q: "$y = \\sin 3x$", a: "$3\\cos 3x$" },
                { q: "$y = \\cos 2x$", a: "$-2\\sin 2x$" },
                { q: "$y = \\cos 3x$", a: "$-3\\sin 3x$" },
                { q: "$y = e^{2x}$", a: "$2e^{2x}$" },
                { q: "$y = e^{3x}$", a: "$3e^{3x}$" },
                { q: "$y = e^{-x}$", a: "$-e^{-x}$" },
                { q: "$y = e^{-2x}$", a: "$-2e^{-2x}$" },
                { q: "$y = \\ln 2x$", a: "$\\frac{1}{x}$" },
                { q: "$y = \\ln 3x$", a: "$\\frac{1}{x}$" },
                { q: "$y = \\ln(x + 1)$", a: "$\\frac{1}{x + 1}$" },
                { q: "$y = \\ln(x - 1)$", a: "$\\frac{1}{x - 1}$" },
                { q: "$y = \\sqrt{2x}$", a: "$\\frac{1}{\\sqrt{2x}}$" },
                { q: "$y = \\sqrt{x + 1}$", a: "$\\frac{1}{2\\sqrt{x + 1}}$" },
                { q: "$y = (x^2 + 1)^2$", a: "$4x(x^2 + 1)$" },
                { q: "$y = \\sin(x + 1)$", a: "$\\cos(x + 1)$" },
                { q: "$y = \\cos(x - 1)$", a: "$-\\sin(x - 1)$" },
                { q: "$y = e^{x+1}$", a: "$e^{x+1}$" },
                { q: "$y = e^{x-1}$", a: "$e^{x-1}$" },
                { q: "$y = \\tan 2x$", a: "$2\\sec^2 2x$" },
                { q: "$y = \\sin^2 x$", a: "$2\\sin x \\cos x$" },
                { q: "$y = \\cos^2 x$", a: "$-2\\sin x \\cos x$" },
                { q: "$y = (\\sin x)^2$", a: "$2\\sin x \\cos x$" },
                { q: "$y = (\\cos x)^2$", a: "$-2\\sin x \\cos x$" },
                { q: "$y = \\sqrt{x^2 + 1}$", a: "$\\frac{x}{\\sqrt{x^2 + 1}}$" },
                { q: "$y = \\ln x^2$", a: "$\\frac{2}{x}$" },
                { q: "$y = \\ln x^3$", a: "$\\frac{3}{x}$" },
                { q: "$y = e^{x^2}$", a: "$2xe^{x^2}$" },
                { q: "$y = \\sin x^2$", a: "$2x\\cos x^2$" },
                { q: "$y = \\cos x^2$", a: "$-2x\\sin x^2$" },
                { q: "$y = (2x + 1)^2$", a: "$4(2x + 1)$" },
                { q: "$y = (3x - 1)^2$", a: "$6(3x - 1)$" },
                { q: "$y = \\sin \\pi x$", a: "$\\pi\\cos \\pi x$" },
                { q: "$y = \\cos \\pi x$", a: "$-\\pi\\sin \\pi x$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...simpleCompositeDerivatives);
            }
            
            // ä¹˜æ³•æ³•åˆ™æ±‚å¯¼ (100é¢˜)
            const productRuleDerivatives = [
                { q: "$y = x\\sin x$", a: "$\\sin x + x\\cos x$" },
                { q: "$y = x\\cos x$", a: "$\\cos x - x\\sin x$" },
                { q: "$y = xe^x$", a: "$e^x + xe^x$" },
                { q: "$y = x\\ln x$", a: "$\\ln x + 1$" },
                { q: "$y = x^2\\sin x$", a: "$2x\\sin x + x^2\\cos x$" },
                { q: "$y = x^2\\cos x$", a: "$2x\\cos x - x^2\\sin x$" },
                { q: "$y = x^2e^x$", a: "$2xe^x + x^2e^x$" },
                { q: "$y = x^2\\ln x$", a: "$2x\\ln x + x$" },
                { q: "$y = (x+1)e^x$", a: "$e^x + (x+1)e^x$" },
                { q: "$y = (x-1)\\sin x$", a: "$\\sin x + (x-1)\\cos x$" },
                { q: "$y = 2x\\sin x$", a: "$2\\sin x + 2x\\cos x$" },
                { q: "$y = 3x\\cos x$", a: "$3\\cos x - 3x\\sin x$" },
                { q: "$y = x^3\\ln x$", a: "$3x^2\\ln x + x^2$" },
                { q: "$y = \\sin x\\cos x$", a: "$\\cos^2 x - \\sin^2 x$" },
                { q: "$y = e^x\\sin x$", a: "$e^x\\sin x + e^x\\cos x$" },
                { q: "$y = e^x\\cos x$", a: "$e^x\\cos x - e^x\\sin x$" },
                { q: "$y = x^2\\ln x$", a: "$x + 2x\\ln x$" },
                { q: "$y = 6x^2$", a: "$12x$" },
                { q: "$y = x^5$", a: "$5x^4$" },
                { q: "$y = \\sqrt{x} \\cdot x$", a: "$\\frac{3\\sqrt{x}}{2}$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...productRuleDerivatives);
            }
            
            // é™¤æ³•æ³•åˆ™æ±‚å¯¼ (100é¢˜)
            const quotientRuleDerivatives = [
                { q: "$y = \\frac{\\sin x}{x}$", a: "$\\frac{x\\cos x - \\sin x}{x^2}$" },
                { q: "$y = \\frac{\\cos x}{x}$", a: "$\\frac{-x\\sin x - \\cos x}{x^2}$" },
                { q: "$y = \\frac{e^x}{x}$", a: "$\\frac{xe^x - e^x}{x^2}$" },
                { q: "$y = \\frac{\\ln x}{x}$", a: "$\\frac{1 - \\ln x}{x^2}$" },
                { q: "$y = \\frac{x}{\\sin x}$", a: "$\\frac{\\sin x - x\\cos x}{\\sin^2 x}$" },
                { q: "$y = \\frac{x}{\\cos x}$", a: "$\\frac{\\cos x + x\\sin x}{\\cos^2 x}$" },
                { q: "$y = \\frac{x}{e^x}$", a: "$\\frac{1 - x}{e^x}$" },
                { q: "$y = \\frac{x + 1}{x}$", a: "$-\\frac{1}{x^2}$" },
                { q: "$y = \\frac{x - 1}{x}$", a: "$\\frac{1}{x^2}$" },
                { q: "$y = \\frac{x^2}{x + 1}$", a: "$\\frac{x^2 + 2x}{(x + 1)^2}$" },
                { q: "$y = \\frac{x}{x + 1}$", a: "$\\frac{1}{(x + 1)^2}$" },
                { q: "$y = \\frac{x^2}{x - 1}$", a: "$\\frac{x^2 - 2x}{(x - 1)^2}$" },
                { q: "$y = \\frac{1}{x + 1}$", a: "$-\\frac{1}{(x + 1)^2}$" },
                { q: "$y = \\frac{1}{x - 1}$", a: "$-\\frac{1}{(x - 1)^2}$" },
                { q: "$y = \\frac{2x}{x^2 + 1}$", a: "$\\frac{2 - 2x^2}{(x^2 + 1)^2}$" },
                { q: "$y = \\tan x$", a: "$\\sec^2 x$" },
                { q: "$y = \\cot x$", a: "$-\\csc^2 x$" },
                { q: "$y = \\frac{x^2 + 1}{x}$", a: "$1 - \\frac{1}{x^2}$" },
                { q: "$y = \\frac{x^2 - 1}{x}$", a: "$1 + \\frac{1}{x^2}$" },
                { q: "$y = \\csc x$", a: "$-\\csc x \\cot x$" }
            ];
            
            for (let i = 0; i < 5; i++) {
                database.push(...quotientRuleDerivatives);
            }
            
            console.log('æ±‚å¯¼é¢˜åº“ç”Ÿæˆå®Œæˆï¼Œæ€»é¢˜æ•°:', database.length);
            return database;
        }

        // å…¨å±€é¢˜åº“
        const megaDatabase = generateMegaDatabase();

        // è·å–å½“å‰å…³å¡çš„é¢˜ç›®æ•°é‡
        function getLevelPairs() {
            return Math.min(4 + currentLevel, 15); // æœ€å¤š15å¯¹é¢˜ç›®
        }

        // æ›´æ–°ç½‘æ ¼å¸ƒå±€
        function updateGridLayout() {
            const pairs = getLevelPairs();
            const total = pairs * 2;
            const grid = document.getElementById('gameGrid');
            
            let cols, rows;
            if (total <= 8) {
                cols = 4; rows = 2;
            } else if (total <= 12) {
                cols = 4; rows = 3;
            } else if (total <= 16) {
                cols = 4; rows = 4;
            } else if (total <= 20) {
                cols = 5; rows = 4;
            } else if (total <= 24) {
                cols = 4; rows = 6;
            } else {
                cols = 5; rows = 6;
            }
            
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
        }

        // åˆ›å»ºä¼˜é›…çš„ç²’å­æ•ˆæœ
        function createParticles(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 12; i++) { // å‡å°‘ç²’å­æ•°é‡
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                
                const angle = (Math.PI * 2 * i) / 12;
                const distance = 150 + Math.random() * 100;
                particle.style.setProperty('--x', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--y', Math.sin(angle) * distance + 'px');
                
                const colors = ['#6b9fff', '#bb86fc', '#64ffda'];
                particle.style.background = `radial-gradient(circle, ${colors[Math.floor(Math.random() * colors.length)]}, transparent)`;
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1500);
            }
        }

        // åˆå§‹åŒ–å…³å¡
        function initLevel() {
            levelScore = 0;
            selectedTile = null;
            isProcessing = false;
            
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('levelScore').textContent = '0';
            document.getElementById('levelTotal').textContent = getLevelPairs();
            
            updateGridLayout();
            initGrid();
            renderGrid();
        }

        // åˆå§‹åŒ–ç½‘æ ¼æ•°æ®
        function initGrid() {
            currentGrid = [];
            const pairs = getLevelPairs();
            const availableProblems = megaDatabase.filter((problem, index) => !usedProblems.has(index));
            
            if (availableProblems.length < pairs) {
                showGameComplete();
                return;
            }
            
            const selectedProblems = [];
            const selectedIndices = [];
            
            while (selectedIndices.length < pairs && availableProblems.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableProblems.length);
                const problemIndex = megaDatabase.indexOf(availableProblems[randomIndex]);
                
                if (!usedProblems.has(problemIndex)) {
                    selectedIndices.push(problemIndex);
                    selectedProblems.push(megaDatabase[problemIndex]);
                    availableProblems.splice(randomIndex, 1);
                }
            }
            
            const tiles = [];
            selectedProblems.forEach((problem, index) => {
                tiles.push({
                    type: 'question',
                    content: problem.q,
                    matchAnswer: problem.a,
                    originalIndex: selectedIndices[index],
                    pairId: index
                });
                tiles.push({
                    type: 'answer',
                    content: problem.a,
                    matchAnswer: problem.a,
                    originalIndex: selectedIndices[index],
                    pairId: index
                });
            });
            
            tiles.sort(() => Math.random() - 0.5);
            currentGrid = tiles;
        }

        // æ¸²æŸ“ç½‘æ ¼
        function renderGrid() {
            const gridElement = document.getElementById('gameGrid');
            gridElement.innerHTML = '';
            
            currentGrid.forEach((tile, index) => {
                if (tile) {
                    const tileElement = document.createElement('div');
                    tileElement.className = `tile ${tile.type}`;
                    tileElement.innerHTML = tile.content;
                    tileElement.dataset.index = index;
                    tileElement.onclick = () => handleTileClick(index);
                    gridElement.appendChild(tileElement);
                }
            });
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        // å¤„ç†ç“·ç –ç‚¹å‡»
        function handleTileClick(index) {
            if (isProcessing) return;
            
            const tile = currentGrid[index];
            if (!tile) return;
            
            const tileElement = document.querySelector(`[data-index="${index}"]`);
            
            if (!selectedTile) {
                selectedTile = { index, tile, element: tileElement };
                tileElement.classList.add('selected');
            } else {
                if (selectedTile.index === index) {
                    tileElement.classList.remove('selected');
                    selectedTile = null;
                } else {
                    checkMatch(selectedTile, { index, tile, element: tileElement });
                }
            }
        }

        // æ£€æŸ¥åŒ¹é…
        function checkMatch(first, second) {
            isProcessing = true;
            
            const isMatch = (first.tile.type !== second.tile.type) && 
                           (first.tile.matchAnswer === second.tile.matchAnswer) &&
                           (first.tile.pairId === second.tile.pairId);
            
            if (isMatch) {
                second.element.classList.add('selected');
                
                setTimeout(() => {
                    createParticles(first.element);
                    createParticles(second.element);
                    
                    first.element.classList.add('matched');
                    second.element.classList.add('matched');
                    
                    usedProblems.add(first.tile.originalIndex);
                    
                    levelScore++;
                    totalAnswered++;
                    
                    document.getElementById('levelScore').textContent = levelScore;
                    
                    setTimeout(() => {
                        currentGrid[first.index] = null;
                        currentGrid[second.index] = null;
                        
                        first.element.style.visibility = 'hidden';
                        second.element.style.visibility = 'hidden';
                        
                        if (levelScore >= getLevelPairs()) {
                            setTimeout(showLevelComplete, 500);
                        }
                        
                        isProcessing = false;
                    }, 800);
                }, 200);
            } else {
                first.element.style.animation = 'shake 0.5s';
                second.element.style.animation = 'shake 0.5s';
                
                setTimeout(() => {
                    first.element.classList.remove('selected');
                    first.element.style.animation = '';
                    second.element.style.animation = '';
                    isProcessing = false;
                }, 500);
            }
            
            selectedTile = null;
        }

        // æ˜¾ç¤ºå…³å¡å®Œæˆ
        function showLevelComplete() {
            document.getElementById('completedLevel').textContent = currentLevel;
            document.getElementById('totalAnswered').textContent = totalAnswered;
            document.getElementById('levelComplete').classList.add('show');
        }

        // ä¸‹ä¸€å…³
        function nextLevel() {
            document.getElementById('levelComplete').classList.remove('show');
            currentLevel++;
            
            const remainingProblems = megaDatabase.length - usedProblems.size;
            if (remainingProblems < getLevelPairs()) {
                showGameComplete();
            } else {
                initLevel();
            }
        }

        // æ˜¾ç¤ºæ¸¸æˆå®Œæˆ
        function showGameComplete() {
            document.getElementById('totalLevels').textContent = currentLevel - 1;
            document.getElementById('gameComplete').classList.add('show');
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            currentLevel = 1;
            totalAnswered = 0;
            usedProblems.clear();
            document.getElementById('gameComplete').classList.remove('show');
            initLevel();
        }

        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', function() {
            createStarfield();
            console.log('æ·±é‚ƒæ˜Ÿç©ºæ±‚å¯¼å¤§å¸ˆå¯åŠ¨ï¼Œé¢˜åº“å¤§å°:', megaDatabase.length);
            initLevel();
        });
    </script>
</body>
</html>